<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CBMC starter kit</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="installation/index.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="tutorial/index.html"><strong aria-hidden="true">3.</strong> Tutorial</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> User manual</div></li><li class="chapter-item expanded "><a href="reference-manual/index.html"><strong aria-hidden="true">5.</strong> Reference manual</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference-manual/cbmc-starter-kit-setup.html"><strong aria-hidden="true">5.1.</strong> cbmc-starter-kit-setup</a></li><li class="chapter-item expanded "><a href="reference-manual/cbmc-starter-kit-setup-proof.html"><strong aria-hidden="true">5.2.</strong> cbmc-starter-kit-setup-proof</a></li><li class="chapter-item expanded "><a href="reference-manual/cbmc-starter-kit-update.html"><strong aria-hidden="true">5.3.</strong> cbmc-starter-kit-update</a></li><li class="chapter-item expanded "><a href="reference-manual/cbmc-starter-kit-migrate-license.html"><strong aria-hidden="true">5.4.</strong> cbmc-starter-kit-migrate-license</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Frequently asked questions</div></li><li class="chapter-item expanded "><a href="resources/index.html"><strong aria-hidden="true">7.</strong> Resources</a></li><li class="chapter-item expanded "><a href="contributing/index.html"><strong aria-hidden="true">8.</strong> Contributing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CBMC starter kit</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="getting-started-with-the-cbmc-starter-kit"><a class="header" href="#getting-started-with-the-cbmc-starter-kit">Getting started with the CBMC starter kit</a></h1>
<p>The <a href="https://github.com/model-checking/cbmc-starter-kit">CBMC starter kit</a> makes
it easy to add CBMC verification to an existing software project.</p>
<p><a href="https://github.com/diffblue/cbmc">CBMC</a> is a model checker for
C. This means that CBMC will explore all possible paths through your code
on all possible inputs, and will check that all assertions in your code are
true.
CBMC can also check for the possibility of
memory safety errors (like buffer overflow) and for instances of
undefined behavior (like signed integer overflow).
CBMC is a bounded model checker, however, which means that the set of all
possible inputs may have to be restricted to all inputs of some bounded size.</p>
<p>For a quick start on using the starter kit, see</p>
<ul>
<li><a href="installation">Installation</a></li>
<li><a href="tutorial">Tutorial</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>The starter kit is a command line tool distributed as both a brew package and a pip package.
The <a href="https://github.com/model-checking/cbmc-starter-kit/releases/latest">starter kit release page</a>
gives installation instructions that we repeat here.</p>
<p>Note: The starter kit used to be distributed as a git repository that you submoduled into
your own repository.  The starter kit is now distributed as a command line tool.  Follow
the <a href="installation/index.html#updating-to-the-command-line-tool">update instructions</a> below to upgrade your project
from using the submodule to using the command line tool.</p>
<h2 id="installing-with-brew"><a class="header" href="#installing-with-brew">Installing with brew</a></h2>
<p>On MacOS, we recommend using brew to install the starter kit:</p>
<pre><code>brew tap aws/tap
brew install cbmc-starter-kit cbmc-viewer litani
</code></pre>
<p>The <a href="https://brew.sh/">brew home page</a> gives instructions for installing brew.
The command <code>brew tap aws/tap</code> taps the AWS repository that contains the brew packages.
The <a href="https://github.com/model-checking/cbmc-viewer">cbmc-viewer</a>
and <a href="https://github.com/awslabs/aws-build-accumulator">litani</a> packages are tools
used by the starter kit.
See the <a href="https://github.com/model-checking/cbmc-viewer/releases/latest">cbmc-viewer release page</a>
and the <a href="https://github.com/awslabs/aws-build-accumulator/releases/latest">litani release page</a>
for other ways to install them if you don't want to use brew.</p>
<h2 id="installing-with-pip"><a class="header" href="#installing-with-pip">Installing with pip</a></h2>
<p>On any machine, you can use pip to install the starter kit:</p>
<pre><code>python3 -m pip install cbmc-starter-kit cbmc-viewer
</code></pre>
<p>The <a href="https://www.python.org/downloads/">python download page</a>
gives instructions for installing python and pip.
The <a href="https://github.com/model-checking/cbmc-viewer">cbmc-viewer</a>
and <a href="https://github.com/awslabs/aws-build-accumulator">litani</a> packages are tools
used by the starter kit.
See the <a href="https://github.com/model-checking/cbmc-viewer/releases/latest">cbmc-viewer release page</a>
and the <a href="https://github.com/awslabs/aws-build-accumulator/releases/latest">litani release page</a>
for installation instructions (we used pip to install <code>cbmc-viewer</code> in the command above).</p>
<h2 id="installing-for-developers"><a class="header" href="#installing-for-developers">Installing for developers</a></h2>
<p>Developers can install the package in &quot;editable mode&quot; which makes
it possible to modify the code in the source tree and then run the command
from the command line as usual to test the changes.
First, install <code>cbmc-viewer</code> and <code>litani</code> as described above if you haven't already.
Then</p>
<ul>
<li>
<p>Clone the repository and install dependencies with</p>
<pre><code>git clone https://github.com/model-checking/cbmc-starter-kit cbmc-starter-kit
python3 -m pip install virtualenv gitpython
</code></pre>
</li>
<li>
<p>Install into a virtual environment with</p>
<pre><code>cd cbmc-starter-kit
make develop
</code></pre>
<p>At this point you can either activate the virtual environment with</p>
<pre><code>source /tmp/cbmc-starter-kit/bin/activate
</code></pre>
<p>or simply add the virtual environment to your path with</p>
<pre><code>export PATH=/tmp/cbmc-starter-kit/bin:$PATH
</code></pre>
</li>
<li>
<p>Uninstall with</p>
<pre><code>cd cbmc-starter-kit
make undevelop
</code></pre>
</li>
</ul>
<h2 id="updating"><a class="header" href="#updating">Updating</a></h2>
<p>To update to the the latest version of the starter kit:</p>
<ul>
<li>Update the starter kit itself with
<pre><code>brew upgrade cbmc-starter-kit
</code></pre>
or
<pre><code>python3 -m pip install cbmc-starter-kit --upgrade
</code></pre>
</li>
<li>Update your repository by changing to the <code>cbmc</code> directory that contains the <code>proofs</code>
directory installed by the starter kit and running the update script:
<pre><code>cd cbmc
cbmc-starter-kit-update
</code></pre>
This will overwrite <code>Makefile.common</code> and <code>run-cbmc-proofs.py</code> in the <code>proofs</code> directory
with the latest versions.</li>
</ul>
<h2 id="updating-to-the-command-line-tool"><a class="header" href="#updating-to-the-command-line-tool">Updating to the command line tool</a></h2>
<p>The starter kit used to be distributed as a git repository that you submoduled into your
own repository.  The same used to be true for litani, the build tool used by the starter kit.
Now both are distributed a command line tools.
We recommend that you migrate to using these command line tools.</p>
<ul>
<li>
<p>Install the starter kit and litani as command line tools</p>
<ul>
<li>On MacOS
<pre><code>brew install cbmc-starter-kit litani
</code></pre>
</li>
<li>On Ubuntu, first download the litani debian package from the
<a href="https://github.com/awslabs/aws-build-accumulator/releases/latest">litani release page</a> then
<pre><code>python3 -m pip install cbmc-starter-kit
apt install ./litani-*.deb
</code></pre>
</li>
</ul>
</li>
<li>
<p>Change to the <code>cbmc</code> directory that contains the <code>proofs</code> directory installed by the
starter kit, and run the update script</p>
<pre><code>cd cbmc
cbmc-starter-kit-update --remove-starter-kit-submodule --remove-litani-submodule
</code></pre>
<p>This will overwrite <code>Makefile.common</code> and <code>run-cbmc-proofs.py</code> in the <code>proofs</code> directory
with the latest versions, and remove the submodules for the starter kit and litani
if they are present.  It will also perform some cleanup actions, such as replacing symbolic
links into the starter kit submodule with copies of the files being linked to, and removing
a set of negative tests that are rarely used.</p>
<p>See <a href="installation/../reference-manual/cbmc-starter-kit-update.html">cbmc-starter-kit-update</a>
for more information.</p>
</li>
</ul>
<p>While you are at it, we have changed the starter kit license from Apache 2.0 to MIT-0, and
you might want to run a script to change copyright headers from Apache to MIT in files
under the <code>cbmc</code> directory:</p>
<pre><code>cd cbmc
cbmc-starter-kit-migrate-license --remove
</code></pre>
<p>See <a href="installation/../reference-manual/cbmc-starter-kit-migrate-license.html">cbmc-starter-kit-migrate-license</a>
for more information.</p>
<h2 id="installation-notes"><a class="header" href="#installation-notes">Installation notes</a></h2>
<p>If you have difficulty installing these tools, please let us know by
submitting a <a href="https://github.com/model-checking/cbmc-starter-kit/issues">GitHub issue</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cbmc-starter-kit-tutorial"><a class="header" href="#cbmc-starter-kit-tutorial">CBMC starter kit tutorial</a></h1>
<p>The <a href="https://github.com/model-checking/cbmc-starter-kit">CBMC starter kit</a>
makes it easy to add CBMC verification to an existing software project.</p>
<p>In this tutorial, we show how to begin proving the memory safety of
a memory allocator that comes with the
<a href="https://github.com/FreeRTOS/FreeRTOS-Kernel">FreeRTOS Kernel</a>.
The kernel comes with five allocators, and we look at the simplest one.
It allocates blocks from a region of memory set aside for the heap.
It maintains a linked list of free blocks and allocates a block from
the first block in the free list that is big enough to satisfy the request.
When the block is freed, it is added back to the free list and merged with
adjacent free blocks already in the free list.
The function we want to prove memory safe is the allocator
<a href="https://github.com/FreeRTOS/FreeRTOS-Kernel/blob/main/portable/MemMang/heap_5.c#L155"><code>pvPortMalloc</code></a>
in the source file
<a href="https://github.com/FreeRTOS/FreeRTOS-Kernel/blob/main/portable/MemMang/heap_5.c">portable/MemMang/heap_5.c</a>.</p>
<p>This tutorial is actually a slightly cleaned-up version of the work done by two
developers who used the starter kit to begin verification of <code>pvPortMalloc</code>.
Two developers who had little more hand-on experience that the demonstration of
CBMC running on a few simple examples were able to use the starter kit
to begin verification in about ten or fifteen minutes, and were able to
breathe some real life into the proof within a few more hours.</p>
<p>Using the starter kit consists of five steps</p>
<ul>
<li><a href="tutorial/index.html#clone-the-source-repository">Clone the source repository</a></li>
<li><a href="tutorial/index.html#configure-the-repository">Configure the repository</a></li>
<li><a href="tutorial/index.html#configure-the-proof">Configure the proof</a></li>
<li><a href="tutorial/index.html#write-the-proof">Write the proof</a></li>
<li><a href="tutorial/index.html#run-cbmc">Run CBMC</a></li>
</ul>
<h2 id="clone-the-source-repository"><a class="header" href="#clone-the-source-repository">Clone the source repository</a></h2>
<p>The first step is to clone the FreeRTOS Kernel repository.</p>
<pre><code>git clone https://github.com/FreeRTOS/FreeRTOS-Kernel.git kernel
cd kernel
git submodule update --init --checkout --recursive
</code></pre>
<p>The first line clones the repository into the directory <code>kernel</code>.
The remaining lines step into the directory <code>kernel</code>
and clone the kernel's submodules.</p>
<h2 id="configure-the-repository"><a class="header" href="#configure-the-repository">Configure the repository</a></h2>
<p>The next step is to configure the repository for CBMC verification.</p>
<pre><code>mkdir cbmc
cd cbmc
cbmc-starter-kit-setup
</code></pre>
<pre><code>What is the project name? Kernel
</code></pre>
<p>The first line create a <code>cbmc</code> directory to hold everything
related to CBMC verification.  The last line runs a setup script
to configure the repository for CBMC verification.
It examines the layout of the repository and asks for a name to use for
the CBMC verification project.  We use the project name <code>Kernel</code>.</p>
<p>Looking at the <code>cbmc</code> directory, we see that some infrastructure has
been installed:</p>
<pre><code>ls
</code></pre>
<pre><code>include         proofs          sources         stubs
</code></pre>
<p>We see directories for holding header files, source files, and stubs written
for the verification work.  Examples of useful stubs for a verification project
are <code>send</code> and <code>receive</code> methods for a physical communication network that
isn't being explicitly modeled.</p>
<p>The most important directory here is the <code>proofs</code> directory that will hold
the CBMC proofs themselves:</p>
<pre><code>ls proofs
</code></pre>
<pre><code>Makefile-project-defines        Makefile.common
Makefile-project-targets        README.md
Makefile-project-testing        run-cbmc-proofs.py
Makefile-template-defines
</code></pre>
<p>The most important files here are</p>
<ul>
<li><code>Makefile.common</code>  This makefile
implements our best practices for CBMC verification:
our best practices for building code for CBMC, our best practices
for running CBMC, and for building a report of CBMC results in a form
that makes it easy to debug issues found by CBMC.</li>
<li><code>run-cbmc-proofs.py</code> This python script runs all of the CBMC proofs in
the <code>proofs</code> directory with maximal concurrency,
and builds a dashboard of the results.
This script is invoked by continuous integration to recheck the proofs on
changes proposed in a pull request.</li>
</ul>
<p>The remaining Makefiles are just hooks for describing project-specific
modifications or definitions.  For example, within <code>Makefile-project-defines</code>
you can define the <code>INCLUDES</code> variable to set the search path for the header
files needed to build the project functions being verified.</p>
<h2 id="configure-the-proof"><a class="header" href="#configure-the-proof">Configure the proof</a></h2>
<p>The next step is to configure CBMC verification of  the memory allocator
<a href="https://github.com/FreeRTOS/FreeRTOS-Kernel/blob/main/portable/MemMang/heap_5.c#L155"><code>pvPortMalloc</code></a>
in the source file
<a href="https://github.com/FreeRTOS/FreeRTOS-Kernel/blob/main/portable/MemMang/heap_5.c">portable/MemMang/heap_5.c</a>.</p>
<pre><code>cd proofs
cbmc-starter-kit-setup-proof
</code></pre>
<pre><code>What is the function name? pvPortMalloc
These source files define a function 'pvPortMalloc':
   0 ../../portable/ARMv8M/secure/heap/secure_heap.c
   1 ../../portable/GCC/ARM_CM23/secure/secure_heap.c
   2 ../../portable/GCC/ARM_CM33/secure/secure_heap.c
   3 ../../portable/IAR/ARM_CM23/secure/secure_heap.c
   4 ../../portable/IAR/ARM_CM33/secure/secure_heap.c
   5 ../../portable/MemMang/heap_1.c
   6 ../../portable/MemMang/heap_2.c
   7 ../../portable/MemMang/heap_3.c
   8 ../../portable/MemMang/heap_4.c
   9 ../../portable/MemMang/heap_5.c
  10 ../../portable/WizC/PIC18/port.c
  11 The source file is not listed here
Select a source file (the options are 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11): 9
</code></pre>
<p>This runs a setup script for the proof that first asks for the name
of the function being verified.  We give it the name <code>pvPortMalloc</code>.
It then examines the source code in the repository and lists all of
the source files that define a function named <code>pvPortMalloc</code>.  It lists
these files and asks us to chose the file with the implementation we
want to verify.  We choose source file number 9.</p>
<p>The <code>proofs</code> directory now contains a subdirectory <code>pvPortMalloc</code>
for verification of the memory allocator <code>pvPortMalloc</code>.</p>
<pre><code>cd pvPortMalloc
ls
</code></pre>
<pre><code>Makefile                cbmc-proof.txt          pvPortMalloc_harness.c
README.md               cbmc-viewer.json
</code></pre>
<p>The most important files in this directory are</p>
<ul>
<li><code>Makefile</code> This is a skeleton of a Makefile to build and run the proof.</li>
<li><code>pvPortMalloc_harness.c</code> This is a skeleton of a proof harness
for <code>pvPortMalloc</code>.</li>
</ul>
<h2 id="write-the-proof"><a class="header" href="#write-the-proof">Write the proof</a></h2>
<h3 id="the-makefile"><a class="header" href="#the-makefile">The Makefile</a></h3>
<p>The Makefile is very simple.</p>
<pre><code>HARNESS_ENTRY = harness
HARNESS_FILE = pvPortMalloc_harness

# This should be a unique identifier for this proof, and will appear on the
# Litani dashboard. It can be human-readable and contain spaces if you wish.
PROOF_UID = pvPortMalloc

DEFINES +=
INCLUDES +=

REMOVE_FUNCTION_BODY +=
UNWINDSET +=

PROOF_SOURCES += $(PROOFDIR)/$(HARNESS_FILE).c
PROJECT_SOURCES += $(SRCDIR)/portable/MemMang/heap_5.c

# If this proof is found to consume huge amounts of RAM, you can set the
# EXPENSIVE variable. With new enough versions of the proof tools, this will
# restrict the number of EXPENSIVE CBMC jobs running at once. See the
# documentation in Makefile.common under the &quot;Job Pools&quot; heading for details.
# EXPENSIVE = true

include ../Makefile.common
</code></pre>
<p>You can see that it identifies the the function <code>pvPortMalloc</code>, it
identifies the source file <code>portable/MemMang/heap_5.c</code>, and it includes
the <code>Makefile.common</code> describing our best practices for using CBMC.</p>
<p>It also gives us the option of defining <code>INCLUDES</code> to set the include path
for header files.  We do need a few header files to build <code>pvPortMalloc</code>,
so let us update the Makefile with</p>
<pre><code>INCLUDES += -I$(PROOFDIR)
INCLUDES += -I$(SRCDIR)/include
INCLUDES += -I$(SRCDIR)/portable/ThirdParty/GCC/Posix
</code></pre>
<p>The final <a href="tutorial/Makefile"><code>Makefile</code></a> is:</p>
<pre><code>HARNESS_ENTRY = harness
HARNESS_FILE = pvPortMalloc_harness

# This should be a unique identifier for this proof, and will appear on the
# Litani dashboard. It can be human-readable and contain spaces if you wish.
PROOF_UID = pvPortMalloc

DEFINES +=
INCLUDES += -I$(PROOFDIR)
INCLUDES += -I$(SRCDIR)/include
INCLUDES += -I$(SRCDIR)/portable/ThirdParty/GCC/Posix

REMOVE_FUNCTION_BODY +=
UNWINDSET +=

PROOF_SOURCES += $(PROOFDIR)/$(HARNESS_FILE).c
PROJECT_SOURCES += $(SRCDIR)/portable/MemMang/heap_5.c

# If this proof is found to consume huge amounts of RAM, you can set the
# EXPENSIVE variable. With new enough versions of the proof tools, this will
# restrict the number of EXPENSIVE CBMC jobs running at once. See the
# documentation in Makefile.common under the &quot;Job Pools&quot; heading for details.
# EXPENSIVE = true

include ../Makefile.common
</code></pre>
<h3 id="the-proof-harness"><a class="header" href="#the-proof-harness">The proof harness</a></h3>
<p>The proof harness is also very simple (especially after omitting some
comments at the top of the file).</p>
<pre><code>/**
 * @file pvPortMalloc_harness.c
 * @brief Implements the proof harness for pvPortMalloc function.
 */

void harness()
{

  /* Insert argument declarations */

  pvPortMalloc( /* Insert arguments */ );
}
</code></pre>
<p>We need to add the main header file <code>FreeRTOS.h</code> for the FreeRTOS project,
and we need to add a function prototype for <code>pvPortMalloc</code> saying that it
takes a size and returns a pointer.</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &quot;FreeRTOS.h&quot;
void *pvPortMalloc(size_t size);
</code></pre>
<p>All that is left is to declare an unconstrained size of type <code>size_t</code> and
pass it to <code>pvPortMalloc.</code></p>
<pre><code>size_t size;
pvPortMalloc(size);
</code></pre>
<p>The final <a href="tutorial/pvPortMalloc_harness.c"><code>pvPortMalloc_harness.c</code></a> is:</p>
<pre><code>/**
 * @file pvPortMalloc_harness.c
 * @brief Implements the proof harness for pvPortMalloc function.
 */

#include &lt;stdlib.h&gt;
#include &quot;FreeRTOS.h&quot;
void *pvPortMalloc(size_t size);

void harness()
{
  size_t size;
  pvPortMalloc(size);
}
</code></pre>
<p>And that is it, with the exception of one last detail.  Building FreeRTOS
requires a configuration file that sets all the parameters used to define
a system configuration.  This kernel repository does not contain a
configuration file, so let us use a simplified
configuration file from a demonstration in another repository.  Let us add
<a href="tutorial/FreeRTOSConfig.h"><code>FreeRTOSConfig.h</code></a> to the <code>pvPortMalloc</code> directory.</p>
<h2 id="run-the-proof"><a class="header" href="#run-the-proof">Run the proof</a></h2>
<p>Finally, we can run the proof:</p>
<pre><code>make
</code></pre>
<p>This builds a report of the results that we can open in a browser</p>
<pre><code>open report/html/index.html
</code></pre>
<p>Examining <a href="tutorial/report/index.html">the report</a>, we see a list of coverage results, a list of
warnings, and a list of errors or issues found by CBMC.  In this report,
there are no errors, but the coverage is <em>terrible</em>: only 40% of the lines
in the function are exercised by CBMC!</p>
<p>Further thought makes it clear that we haven't set up the heap
that the allocator is supposed to be using.  We have invoked
an allocator to allocate space on a heap, but we haven't allocated
or initialized the heap itself yet!</p>
<p>At this point it is interesting to see what the developers
did to breathe some life into this verification effort.
Their proof harness looked something like this
<a href="tutorial/pvPortMalloc_harness1.c"><code>pvPortMalloc_harness.c</code></a>:</p>
<pre><code>/**
 * @file pvPortMalloc_harness.c
 * @brief Implements the proof harness for pvPortMalloc function.
 */

#include &lt;stdlib.h&gt;
#include &quot;FreeRTOS.h&quot;
void * pvPortMalloc( size_t xWantedSize );

void harness()
{
  /* allocate heap */
  uint8_t app_heap[ configTOTAL_HEAP_SIZE ];

  /* initialize heap */
  HeapRegion_t xHeapRegions[] =
    {
      { ( unsigned char * ) app_heap, sizeof( app_heap ) },
      { NULL,                         0                  }
    };
  vPortDefineHeapRegions( xHeapRegions );

  /* mess up heap */
  size_t xWantedSize1, xWantedSize2, xWantedSize3;
  void* pv1 = pvPortMalloc( xWantedSize1 );
  void* pv2 = pvPortMalloc( xWantedSize2 );
  void* pv3 = pvPortMalloc( xWantedSize3 );
  vPortFree( pv2 );

  size_t xWantedSize;
  pvPortMalloc( xWantedSize );
}
</code></pre>
<p>You can see that they allocate the heap, they initialize the heap
data structures, and then they mess up the heap a bit by allocating
three chunks of unconstrained size and freeing the middle one.
Then they invoke <code>pvPortMalloc</code> with an unconstrained size.
Doing this was enough to get complete code coverage and uncover a
few minor instances of integer overflow.</p>
<p>Of course, this is not a complete proof of memory safety.  This is a proof that
if you allocate a heap consisting of a single chunk of memory of a size
fixed by the configuration, and if you allocate three chunks of unconstrained
size and free the middle one, then <code>pvPortMalloc</code> will exhibit no memory
safety errors or other undefined behaviors.  But it is an elegant example
of how quickly developers were able to get started doing real work.
Good for them!  And, soon, good for you.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference-manual"><a class="header" href="#reference-manual">Reference manual</a></h1>
<p>The CBMC Starter Kit makes it easy to add CBMC verification to a
software project.</p>
<ul>
<li><a href="reference-manual/cbmc-starter-kit-setup.html">cbmc-starter-kit-setup</a></li>
<li><a href="reference-manual/cbmc-starter-kit-setup-proof.html">cbmc-starter-kit-setup-proof</a></li>
<li><a href="reference-manual/cbmc-starter-kit-update.html">cbmc-starter-kit-update</a></li>
<li><a href="reference-manual/cbmc-starter-kit-migrate-license.html">cbmc-starter-kit-migrate-license</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference-manual-1"><a class="header" href="#reference-manual-1">Reference manual</a></h1>
<h2 id="name"><a class="header" href="#name">Name</a></h2>
<p><code>cbmc-starter-kit-setup</code> - Set up CBMC proof infrastructure for a repository</p>
<h2 id="synopsis"><a class="header" href="#synopsis">Synopsis</a></h2>
<pre><code>cbmc-starter-kit-setup [-h] [--verbose] [--debug] [--version]
</code></pre>
<h2 id="description"><a class="header" href="#description">Description</a></h2>
<p>This script sets up the CBMC proof infrastructure for a repository.
It locates the root of the repository, it asks for a name to use
for the CBMC verification activity (any name will do, and the name can be
changed at any time), and it copies into the current directory a collection
of files that simplify getting started with CBMC.</p>
<p>We recommend that you create a directory with a name like <code>cbmc</code> somewhere
within the repository to hold the CBMC verification work.  This script
assumes that it is running in this verification directory, and assumes
that this directory is under the root of a git repository.</p>
<p>This script needs to be run only one time to prepare the repository for
CBMC verification.</p>
<h2 id="options"><a class="header" href="#options">Options</a></h2>
<p><code>--verbose</code></p>
<ul>
<li>Verbose output.</li>
</ul>
<p><code>--debug</code></p>
<ul>
<li>Debugging output.</li>
</ul>
<p><code>--version</code></p>
<ul>
<li>Display version number and exit.</li>
</ul>
<p><code>--help, -h</code></p>
<ul>
<li>Print the help message and exit.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference-manual-2"><a class="header" href="#reference-manual-2">Reference manual</a></h1>
<h2 id="name-1"><a class="header" href="#name-1">Name</a></h2>
<p><code>cbmc-starter-kit-setup-proof</code> - Set up CBMC proof infrastructure for a proof</p>
<h2 id="synopsis-1"><a class="header" href="#synopsis-1">Synopsis</a></h2>
<pre><code>cbmc-starter-kit-setup-proof [-h] [--verbose] [--debug] [--version]
</code></pre>
<h2 id="description-1"><a class="header" href="#description-1">Description</a></h2>
<p>This script sets up the CBMC proof infrastructure for an individual proof.
It asks for the name of the function under test.
It then searches the repository for source files that define a
function with that name, and asks you to select the file giving the
implementation you want to test.
If none of the files listed is the correct file, you can give the path
to the correct source file yourself.
Finally, the script creates a directory with the name of the function
and copies into that directory some files to simplify getting started
with the verification of that function.  Most important, it copies
a skeleton of a Makefile and skeleton of a proof harness that you can
edit to get started.</p>
<p>This script is usually run in the CBMC verification root
(the directory you created to hold the CBMC verification work,
and in which you ran the <code>cbmc-stater-kit-setup</code> script).
This script can, however, be run in any subdirectory of the
CBMC verification root.  In this way, you can group verification of
similar functions together in a hierarchy of subdirectories.</p>
<p>This script will need to be run once for each function you want
to verify.</p>
<h2 id="options-1"><a class="header" href="#options-1">Options</a></h2>
<p><code>--verbose</code></p>
<ul>
<li>Verbose output.</li>
</ul>
<p><code>--debug</code></p>
<ul>
<li>Debugging output.</li>
</ul>
<p><code>--version</code></p>
<ul>
<li>Display version number and exit.</li>
</ul>
<p><code>--help, -h</code></p>
<ul>
<li>Print the help message and exit.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference-manual-3"><a class="header" href="#reference-manual-3">Reference manual</a></h1>
<h2 id="name-2"><a class="header" href="#name-2">Name</a></h2>
<p><code>cbmc-starter-kit-update</code> - Update CBMC starter kit in a CBMC proof repository</p>
<h2 id="synopsis-2"><a class="header" href="#synopsis-2">Synopsis</a></h2>
<pre><code>cbmc-starter-kit-update [-h] [--cbmc-root CBMC]
                        [--starter-kit-root STARTER_KIT] [--no-migrate]
                        [--no-test-removal] [--no-update]
                        [--remove-starter-kit-submodule]
                        [--remove-litani-submodule] [--verbose]
                        [--debug] [--version]
</code></pre>
<h2 id="description-2"><a class="header" href="#description-2">Description</a></h2>
<p>This script is used to update the CBMC starter kit installed in your
repository to the lastest version.  It copies (overwrites) two files
into your repository (<code>Makefile.common</code> and <code>run-cbmc-proofs.py</code>).
These are the two files in the starter kit that encode our best
practices for how to use CBMC in a software verification project.</p>
<p>This script will also migrate your repository from early versions of
the starter kit and litani (the build system used by the starter kit)
to modern versions.  Early versions of the starter kit and litani were
distributed as as git repositories that you submoduled into your
repository.  The starter kit also installed symbolic links from your
repository into the starter kit submodule. This script will remove the
symbolic links (replace them with the files they are linking to) and will
also remove the starter kit and litani submodules from your repository
if you give the <code>--remove-stater-kit-submodule</code> and
<code>--remove-litani-submodule</code> flags (flags you almost certainly want to
use during the migration).  Finally, it will remove some regression tests
that were distributed with early versions of the starter kit that most people
don't use.</p>
<h2 id="options-2"><a class="header" href="#options-2">Options</a></h2>
<p><code>--cbmc-root CBMC</code></p>
<ul>
<li>Root of CBMC proof infrastructure (default: &quot;.&quot;)</li>
</ul>
<p><code>--starter-kit-root STARTER_KIT</code></p>
<ul>
<li>Root of CBMC starter kit submodule (default: None or
root of starter kit submodule installed in repository
containing CBMC)</li>
</ul>
<p><code>--no-migrate</code></p>
<ul>
<li>Do not remove symlinks under CBMC. Normally remove
symlinks under CBMC to files under STARTER_KIT.</li>
</ul>
<p><code>--no-test-removal</code></p>
<ul>
<li>Do not remove negative tests in CBMC/negative_tests.
Normally remove the directory CBMC/negative_tests
since most projects don't use these tests.</li>
</ul>
<p><code>--no-update</code></p>
<ul>
<li>Do not update Makefile.common and run-cbmc-proofs.py
under CBMC/proofs. Normally update these files with
the versions in the starter kit package.</li>
</ul>
<p><code>--remove-starter-kit-submodule</code></p>
<ul>
<li>Remove the starter kit submodule if it is present.
Normally just recommend removal.</li>
</ul>
<p><code>--remove-litani-submodule</code></p>
<ul>
<li>Remove the litani submodule and update the definition
of LITANI in Makefile-template-defines if the litani
submodule is present and the litani command is in
PATH. Normally just recommend removal.</li>
</ul>
<p><code>--verbose</code></p>
<ul>
<li>Verbose output</li>
</ul>
<p><code>--debug</code></p>
<ul>
<li>Debug output</li>
</ul>
<p><code>--version</code></p>
<ul>
<li>Display version and exit</li>
</ul>
<p><code>--help, -h</code></p>
<ul>
<li>Print the help message and exit.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference-manual-4"><a class="header" href="#reference-manual-4">Reference manual</a></h1>
<h2 id="name-3"><a class="header" href="#name-3">Name</a></h2>
<p><code>cbmc-starter-kit-migrate-license</code> - Remove references to Apache license from CBMC starter kit.</p>
<h2 id="synopsis-3"><a class="header" href="#synopsis-3">Synopsis</a></h2>
<pre><code>cbmc-starter-kit-migrate-license [-h] [--proofdir PROOFDIR] [--remove]
                                 [--verbose] [--debug] [--version]
</code></pre>
<h2 id="description-3"><a class="header" href="#description-3">Description</a></h2>
<p>This script is used to remove references to the Apache license installed
by early versions of the starter kit.</p>
<p>The CBMC starter kit was originally released under the Apache
license. All files in the starter kit contained references to the
Apache license. The starter kit installation scripts copied files from
the stater kit into the project repository. This became an issue when
the project repository was released under a more permissive
license. This script removes all references to the Apache license from
the files copied into the project repository from the starter kit, and
uses the MIT-0 license instead.</p>
<h2 id="options-3"><a class="header" href="#options-3">Options</a></h2>
<p><code>--proofdir PROOFDIR</code></p>
<ul>
<li>Root of the proof subtree (default: .)</li>
</ul>
<p><code>--remove</code></p>
<ul>
<li>Remove Apache references from files under PROOFDIR (otherwise just list them)</li>
</ul>
<p><code>--help, -h</code></p>
<p><code>--verbose</code></p>
<ul>
<li>Verbose output.</li>
</ul>
<p><code>--debug</code></p>
<ul>
<li>Debugging output.</li>
</ul>
<p><code>--version</code></p>
<ul>
<li>Display version number and exit.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cbmc-starter-kit-resources"><a class="header" href="#cbmc-starter-kit-resources">CBMC starter kit resources</a></h1>
<ul>
<li>
<p>CBMC (the model checker used by the starter kit)</p>
<ul>
<li><a href="http://www.cprover.org/cprover-manual">Documentation</a> and <a href="https://github.com/diffblue/cbmc/blob/develop/doc/cprover-manual/cbmc-tutorial.md">tutorial</a></li>
<li><a href="https://github.com/diffblue/cbmc">Source code</a></li>
</ul>
</li>
<li>
<p>Litani (the build system used by the starter kit)</p>
<ul>
<li><a href="https://awslabs.github.io/aws-build-accumulator/">Documentation</a></li>
<li><a href="https://github.com/awslabs/aws-build-accumulator">Source code</a></li>
</ul>
</li>
<li>
<p>CBMC starter kit</p>
<ul>
<li><a href="https://github.com/model-checking/cbmc-starter-kit">Source code</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>This material is a work in progress.  If you have suggestions,
corrections, or questions, contact us by submitting a
<a href="https://github.com/model-checking/cbmc-starter-kit/issues">GitHub issue</a>.
If you have some examples of your own that you would like to contribute,
submit your contributions as a
<a href="https://github.com/model-checking/cbmc-starter-kit/pulls">GitHub pull request</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
